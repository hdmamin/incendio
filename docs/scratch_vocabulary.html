---

title: Title
keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/scratch_vocabulary.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">htools</span> <span class="k">import</span> <span class="n">hdir</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;ab c&#39;</span><span class="p">)</span>
<span class="n">tmp2</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;a, ccc bb d ee&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">({</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tmp1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp2</span><span class="o">.</span><span class="n">keys</span><span class="p">()))})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Counter({&#39;a&#39;: 1, &#39;b&#39;: 1, &#39; &#39;: 1, &#39;c&#39;: 1})
Counter({&#39; &#39;: 4, &#39;c&#39;: 3, &#39;b&#39;: 2, &#39;e&#39;: 2, &#39;a&#39;: 1, &#39;,&#39;: 1, &#39;d&#39;: 1})
{&#39;b&#39;, &#39;d&#39;, &#39; &#39;, &#39;c&#39;, &#39;a&#39;, &#39;e&#39;, &#39;,&#39;}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tmp1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tmp2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="o">*</span><span class="n">tmp1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="o">*</span><span class="n">tmp2</span><span class="o">.</span><span class="n">keys</span><span class="p">()}}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;b&#39;: 3, &#39;d&#39;: 1, &#39; &#39;: 5, &#39;c&#39;: 4, &#39;a&#39;: 2, &#39;e&#39;: 2, &#39;,&#39;: 1}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>scratch_add_dicts.ipynb              scratch_train.ipynb
scratch_inheritance_and_mixins.ipynb scratch_vocabulary.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Vocabulary</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w2idx</span><span class="p">,</span> <span class="n">w2vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx_misc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corpus_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">all_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defines a vocabulary object for NLP problems, allowing users to </span>
<span class="sd">        encode text with indices or embeddings.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        w2idx: dict[str, int]</span>
<span class="sd">            Dictionary mapping words to their integer index in a vocabulary. </span>
<span class="sd">            The indices must allow for idx_misc to be added to the dictionary,</span>
<span class="sd">            so in the default case this should have a minimum index of 2. If</span>
<span class="sd">            a longer idx_misc is passed in, the minimum index would be larger.</span>
<span class="sd">        w2vec: dict[str, np.array]</span>
<span class="sd">            Dictionary mapping words to their embedding vectors stored as</span>
<span class="sd">            numpy arrays (optional).</span>
<span class="sd">        idx_misc: dict</span>
<span class="sd">            A dictionary mapping non-word tokens to indices. If none is passed</span>
<span class="sd">            in, a default version will be used with keys for unknown tokens</span>
<span class="sd">            and padding. A customized version might pass in additional tokens</span>
<span class="sd">            for repeated characters or all caps, for example.</span>
<span class="sd">        corpus_counts: collections.Counter</span>
<span class="sd">            Counter dict mapping words to their number of occurrences in a </span>
<span class="sd">            corpus (optional).</span>
<span class="sd">        all_lower: bool</span>
<span class="sd">            Specifies whether the data you&#39;ve passed in (w2idx, w2vec, i2w) is</span>
<span class="sd">            all lowercase. Note that this will NOT change any of this data. If</span>
<span class="sd">            True, it simply lowercases user-input words when looking up their</span>
<span class="sd">            index or vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">idx_misc</span><span class="p">:</span>
            <span class="n">idx_misc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span> <span class="o">=</span> <span class="n">idx_misc</span>
        <span class="c1"># Check that space has been left for misc keys.</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_misc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">w2idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="c1"># Core data structures.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span><span class="p">,</span> <span class="o">**</span><span class="n">w2idx</span><span class="p">}</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> 
                                                 <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w2vec</span> <span class="o">=</span> <span class="n">w2vec</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="c1"># Miscellaneous other attributes.</span>
        <span class="k">if</span> <span class="n">w2vec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">w2vec</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpus_counts</span> <span class="o">=</span> <span class="n">corpus_counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w2vec</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_lower</span> <span class="o">=</span> <span class="n">all_lower</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_glove_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">max_lines</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="n">idx_misc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Vocabulary object by loading GloVe vectors from a text</span>
<span class="sd">        file. The embeddings are all lowercase so the user does not have the</span>
<span class="sd">        option to set the all_lower parameter.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Path to file containing glove vectors.</span>
<span class="sd">        max_lines: int, float (optional)</span>
<span class="sd">            Loading the GloVe vectors can be slow, so for testing purposes</span>
<span class="sd">            it can be helpful to read in a subset. If no value is provided,</span>
<span class="sd">            all 400,000 lines in the file will be read in.</span>
<span class="sd">        idx_misc: dict</span>
<span class="sd">            Map non-standard tokens to indices. See constructor docstring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w2idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">w2vec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">misc_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">idx_misc</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_misc</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_lines</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">word</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">w2idx</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">misc_len</span>
                <span class="n">w2vec</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
           
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">w2idx</span><span class="p">,</span> <span class="n">w2vec</span><span class="p">,</span> <span class="n">idx_misc</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_tokens</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">idx_misc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a Vocabulary object from a list or array of tokens.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        tokens: list[str]</span>
<span class="sd">            The word-tokenized corpus.</span>
<span class="sd">        idx_misc: dict</span>
<span class="sd">            Map non-standard tokens to indices. See constructor docstring.</span>
<span class="sd">        all_lower: bool</span>
<span class="sd">            Specifies whether your tokens are all lowercase.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Vocabulary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">misc_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">idx_misc</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_misc</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">w2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> 
                 <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(),</span> <span class="n">misc_len</span><span class="p">)}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">w2idx</span><span class="p">,</span> <span class="n">idx_misc</span><span class="o">=</span><span class="n">idx_misc</span><span class="p">,</span> <span class="n">corpus_counts</span><span class="o">=</span><span class="n">counts</span><span class="p">,</span> 
                   <span class="n">all_lower</span><span class="o">=</span><span class="n">all_lower</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a previously saved Vocabulary object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Location of pickled Vocabulary file.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Vocabulary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pickle Vocabulary object for later use. We can then quickly load </span>
<span class="sd">        the object using torch.load(path), which can be much faster than</span>
<span class="sd">        re-computing everything when the vocab size becomes large.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Where to save the output file.</span>
<span class="sd">        verbose: bool</span>
<span class="sd">            If True, print message showing where the object was saved to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Saving vocabulary to </span><span class="si">{path}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">filter_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter your vocabulary by specifying a max number of words or a min</span>
<span class="sd">        frequency in the corpus. When done in place, this also sorts vocab by</span>
<span class="sd">        frequency with more common words coming first (after idx_misc).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        tokens: list[str]</span>
<span class="sd">            A tokenized list of words in the corpus (must be all lowercase </span>
<span class="sd">            when self.all_lower=True, such as when using GloVe vectors). There </span>
<span class="sd">            is no need to hold out test data here since we are not using </span>
<span class="sd">            labels.</span>
<span class="sd">        max_words: int (optional)</span>
<span class="sd">            Provides an upper threshold for the number of words in the</span>
<span class="sd">            vocabulary. If no value is passed in, no maximum limit will be</span>
<span class="sd">            enforced.</span>
<span class="sd">        min_freq: int (optional)</span>
<span class="sd">            Provides a lower threshold for the number of times a word must </span>
<span class="sd">            appear in the corpus to remain in the vocabulary. If no value is</span>
<span class="sd">            passed in, no minimum limit will be enforced.</span>
<span class="sd">            </span>
<span class="sd">            Note that we can specify values for both max_words and min_freq</span>
<span class="sd">            if desired. If no values are passed in for either, no pruning of</span>
<span class="sd">            the vocabulary will be performed.</span>
<span class="sd">        inplace: bool</span>
<span class="sd">            If True, will change the object&#39;s attributes </span>
<span class="sd">            (w2idx, w2vec, and i2w) to reflect the newly filtered vocabulary.</span>
<span class="sd">            If False, will not change the object, but will simply compute word</span>
<span class="sd">            counts and return what the new w2idx would be. This can be helpful</span>
<span class="sd">            for experimentation, as we may want to try out multiple values of</span>
<span class="sd">            min_freq to decide how many words to keep. After the first call,</span>
<span class="sd">            the attribute corpus_counts can also be examined to help determine</span>
<span class="sd">            the desired vocab size.</span>
<span class="sd">        recompute: bool</span>
<span class="sd">            If True, will calculate word counts from the given tokens. If </span>
<span class="sd">            False (the default), this will use existing counts if there are </span>
<span class="sd">            any. </span>
<span class="sd">            </span>
<span class="sd">            The idea is that if we call this method, then realize we want</span>
<span class="sd">            to change the corpus, we should calculate new word counts. </span>
<span class="sd">            However, if we are simply calling this method multiple times on </span>
<span class="sd">            the same corpus while deciding on the exact vocab size we want,</span>
<span class="sd">            we should not recompute the word counts.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        dict or None: When called inplace, nothing is returned. When not </span>
<span class="sd">        inplace, </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">misc_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recompute</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus_counts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">corpus_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> 
                    <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corpus_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">max_words</span><span class="p">),</span>
                                 <span class="n">misc_len</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">min_freq</span><span class="p">}</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># Relies on python3.7 dicts retaining insertion order.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span> <span class="o">=</span> <span class="n">filtered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w2vec</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered</span>
        
    <span class="k">def</span> <span class="nf">build_embedding_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a 2D numpy array of embedding vectors where row[i] </span>
<span class="sd">        corresponds to word i in the vocabulary. This can be used to </span>
<span class="sd">        initialize weights in the model&#39;s embedding layer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        inplace: bool</span>
<span class="sd">            If True, will store the output in the object&#39;s embedding_matrix</span>
<span class="sd">            attribute. If False (default behavior), will simply return the </span>
<span class="sd">            matrix without storing it as part of the object. In the </span>
<span class="sd">            recommended case where inplace==False, we can store the output</span>
<span class="sd">            in another variable which we can use to initialize the weights in</span>
<span class="sd">            Torch, then delete the object and free up memory using </span>
<span class="sd">            gc.collect().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">emb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embedding_matrix</span> <span class="o">=</span> <span class="n">emb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">emb</span>
    
    <span class="k">def</span> <span class="nf">idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will map a word (str) to its index (int) in the vocabulary. </span>
<span class="sd">        If a string is passed in and the word is not present, the index</span>
<span class="sd">        corresponding to the &lt;UNK&gt; token is returned.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        word: str</span>
<span class="sd">            A word that needs to be mapped to an integer index.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        int: The index of the given word in the vocabulary.</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        ---------</span>
<span class="sd">        &gt;&gt;&gt; vocab.idx(&#39;the&#39;)</span>
<span class="sd">        2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lower</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This maps a word to its corresponding embedding vector. If not</span>
<span class="sd">        contained in the vocab, a vector of zeros will be returned.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        word: str</span>
<span class="sd">            A word that needs to be mapped to a vector.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        np.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lower</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_misc</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2vec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2vec</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">pad_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trim_start</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encode text so that each token is replaced by its integer index in </span>
<span class="sd">        the vocab.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        text: str</span>
<span class="sd">            Raw text to be encoded.</span>
<span class="sd">        nlp: spacy.lang.en.English</span>
<span class="sd">            Spacy tokenizer. Typically want to disable &#39;parser&#39;, &#39;tagger&#39;, and</span>
<span class="sd">            &#39;ner&#39; as they aren&#39;t used here and slow down the encoding process.</span>
<span class="sd">        max_len: int</span>
<span class="sd">            Length of output encoding. If text is shorter, it will be padded </span>
<span class="sd">            to fit the specified length. If text is longer, it will be </span>
<span class="sd">            trimmed.</span>
<span class="sd">        pad_end: bool</span>
<span class="sd">            If True, add padding to the end of short sentences. If False, pad</span>
<span class="sd">            the start of these sentences.</span>
<span class="sd">        trim_start: bool</span>
<span class="sd">            If True, trim off the start of sentences that are too long. If </span>
<span class="sd">            False, trim off the end.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        np.array[int]: Array of length max_len containing integer indices</span>
<span class="sd">            corresponding to the words passed in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">max_len</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">)</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)]</span>
        
        <span class="c1"># Trim sentence in case it&#39;s longer than max_len.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trim_start</span><span class="p">:</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_len</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>

        <span class="c1"># Replace zeros at start or end, depending on choice of pad_end.</span>
        <span class="k">if</span> <span class="n">pad_end</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)]</span> <span class="o">=</span> <span class="n">encoded</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="n">max_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">):]</span> <span class="o">=</span> <span class="n">encoded</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a list of indices to a string of words/tokens.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        idx: list[int]</span>
<span class="sd">            A list of integers indexing into the vocabulary. This will often </span>
<span class="sd">            be the output of the encode() method.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        list[str]: A list of words/tokens reconstructed by indexing into the </span>
<span class="sd">            vocabulary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will map an index (int) to a word (str).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        i: int</span>
<span class="sd">            Integer index for a word.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        str: Word corresponding to the given index.</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        ---------</span>
<span class="sd">        &gt;&gt;&gt; vocab = Vocabulary(w2idx, w2vec)</span>
<span class="sd">        &gt;&gt;&gt; vocab[1]</span>
<span class="sd">        &#39;&lt;UNK&gt;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of words in vocabulary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">word</span>
            
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">w2idx</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Vocabulary</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w2vec&#39;</span><span class="p">,</span> <span class="s1">&#39;embedding_matrix&#39;</span><span class="p">}</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hdir</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                 <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;attribute&#39;</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> 
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Vocabulary({len(self)} words&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;, </span><span class="si">{self.dim}</span><span class="s1">-D embeddings&#39;</span>
        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en_core_web_sm&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">glove_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/hmamin/data/glove/glove.6B.100d.txt&#39;</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="o">.</span><span class="n">from_glove_file</span><span class="p">(</span><span class="n">glove_path</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Vocabulary(5002 words, 100-D embeddings)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>5002</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;tmp.pkl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saving vocabulary to tmp.pkl.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v2</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="o">.</span><span class="n">from_pickle</span><span class="p">(</span><span class="s1">&#39;tmp.pkl&#39;</span><span class="p">)</span>
<span class="n">vocab</span> <span class="o">==</span> <span class="n">v2</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">v2</span><span class="o">.</span><span class="n">w2idx</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">w2idx</span>
<span class="k">assert</span> <span class="n">v2</span><span class="o">.</span><span class="n">i2w</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">i2w</span>
<span class="k">assert</span> <span class="n">v2</span><span class="o">.</span><span class="n">corpus_counts</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">corpus_counts</span>
<span class="k">assert</span> <span class="n">v2</span><span class="o">.</span><span class="n">idx_misc</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">idx_misc</span>
<span class="k">assert</span> <span class="n">v2</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">dim</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">w2vec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">w2vec</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">v2</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>85</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;&lt;PAD&gt;&#39;, &#39;&lt;UNK&gt;&#39;, &#39;the&#39;, &#39;,&#39;, &#39;.&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">vocab</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">word</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0 &lt;PAD&gt; 1 [0. 0. 0.]
1 &lt;UNK&gt; 1 [0. 0. 0.]
2 the 2 [-0.038194 -0.24487   0.72812 ]
3 , 3 [-0.10767  0.11053  0.59812]
4 . 4 [-0.33979  0.20941  0.46348]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">build_embedding_matrix</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">embedding_matrix</span><span class="p">)</span>
<span class="n">emb</span><span class="p">[:</span><span class="mi">10</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>None
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.      ,  0.      ,  0.      ,  0.      ,  0.      ],
       [ 0.      ,  0.      ,  0.      ,  0.      ,  0.      ],
       [-0.038194, -0.24487 ,  0.72812 , -0.39961 ,  0.083172],
       [-0.10767 ,  0.11053 ,  0.59812 , -0.54361 ,  0.67396 ],
       [-0.33979 ,  0.20941 ,  0.46348 , -0.64792 , -0.38377 ],
       [-0.1529  , -0.24279 ,  0.89837 ,  0.16996 ,  0.53516 ],
       [-0.1897  ,  0.050024,  0.19084 , -0.049184, -0.089737],
       [-0.071953,  0.23127 ,  0.023731, -0.50638 ,  0.33923 ],
       [ 0.085703, -0.22201 ,  0.16569 ,  0.13373 ,  0.38239 ],
       [-0.27086 ,  0.044006, -0.02026 , -0.17395 ,  0.6444  ]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">emb</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1525</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># vocab.build_embedding_matrix(True)</span>
<span class="c1"># vocab.embedding_matrix.shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;I went to the beach today. It was sunny and warm. The water was</span>
<span class="s2">very blue and cold. The relaxing atmosphere provided a welcome break from the</span>
<span class="s2">daily routine. beach sunny sunny sunny sunny atmosphere atmosphere atmosphere</span>
<span class="s2">blue blue blue blue blue. beach next beach atmosphere&quot;&quot;&quot;</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">,</span> <span class="s1">&#39;tagger&#39;</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">))</span>

<span class="n">filtered</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">filter_tokens</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
<span class="n">filtered</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>54
17
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;&lt;PAD&gt;&#39;: 0,
 &#39;&lt;UNK&gt;&#39;: 1,
 &#39;blue&#39;: 2,
 &#39;.&#39;: 3,
 &#39;sunny&#39;: 4,
 &#39;atmosphere&#39;: 5,
 &#39;the&#39;: 6,
 &#39;beach&#39;: 7,
 &#39;\n&#39;: 8,
 &#39;was&#39;: 9,
 &#39;and&#39;: 10,
 &#39;i&#39;: 11,
 &#39;went&#39;: 12,
 &#39;to&#39;: 13,
 &#39;today&#39;: 14,
 &#39;it&#39;: 15,
 &#39;warm&#39;: 16}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">corpus_counts</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Counter({&#39;i&#39;: 1,
         &#39;went&#39;: 1,
         &#39;to&#39;: 1,
         &#39;the&#39;: 4,
         &#39;beach&#39;: 4,
         &#39;today&#39;: 1,
         &#39;.&#39;: 5,
         &#39;it&#39;: 1,
         &#39;was&#39;: 2,
         &#39;sunny&#39;: 5,
         &#39;and&#39;: 2,
         &#39;warm&#39;: 1,
         &#39;water&#39;: 1,
         &#39;\n&#39;: 3,
         &#39;very&#39;: 1,
         &#39;blue&#39;: 6,
         &#39;cold&#39;: 1,
         &#39;relaxing&#39;: 1,
         &#39;atmosphere&#39;: 5,
         &#39;provided&#39;: 1,
         &#39;a&#39;: 1,
         &#39;welcome&#39;: 1,
         &#39;break&#39;: 1,
         &#39;from&#39;: 1,
         &#39;daily&#39;: 1,
         &#39;routine&#39;: 1,
         &#39;next&#39;: 1})</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>5001</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">filter_tokens</span><span class="p">(</span><span class="n">corpus</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>11</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">w2idx</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;&lt;PAD&gt;&#39;: 0,
 &#39;&lt;UNK&gt;&#39;: 1,
 &#39;blue&#39;: 2,
 &#39;.&#39;: 3,
 &#39;sunny&#39;: 4,
 &#39;atmosphere&#39;: 5,
 &#39;the&#39;: 6,
 &#39;beach&#39;: 7,
 &#39;\n&#39;: 8,
 &#39;was&#39;: 9,
 &#39;and&#39;: 10}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">i2w</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;&lt;PAD&gt;&#39;,
 &#39;&lt;UNK&gt;&#39;,
 &#39;blue&#39;,
 &#39;.&#39;,
 &#39;sunny&#39;,
 &#39;atmosphere&#39;,
 &#39;the&#39;,
 &#39;beach&#39;,
 &#39;\n&#39;,
 &#39;was&#39;,
 &#39;and&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;BLUE&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">all_lower</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;BLUE&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">all_lower</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">vocab</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s1">&#39;BLUE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># vocab.save(&#39;../data/vocab.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># vocab2 = torch.load(&#39;../data/vocab.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># print(vocab.w2idx == vocab2.w2idx)</span>
<span class="c1"># del vocab2</span>
<span class="c1"># gc.collect()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="custom-idx_misc">custom idx_misc<a class="anchor-link" href="#custom-idx_misc">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">custom_misc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&lt;XXrep&gt;&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;&lt;XXcaps&gt;&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="o">.</span><span class="n">from_glove_file</span><span class="p">(</span><span class="n">glove_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">),</span> <span class="mi">5_000</span><span class="p">,</span> <span class="n">custom_misc</span><span class="p">)</span>
<span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Vocabulary(5004 words, 50-D embeddings)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">dim</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>50</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;boat&#39;</span><span class="p">,</span> <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[4, 2381, 170, 6]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Without-Glove">Without Glove<a class="anchor-link" href="#Without-Glove">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">,</span> <span class="s1">&#39;tagger&#39;</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">])]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/hmamin/data/bbc/tech/401.txt&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">text_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="o">.</span><span class="n">from_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">all_lower</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Vocabulary(988 words)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">dim</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s1">&#39;the&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>60</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;the&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>4</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">vocab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">vocab</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0 &lt;PAD&gt; 0 [0.]
1 &lt;UNK&gt; 1 [0.]
2 . 2 [0.]
3 , 3 [0.]
4 the 4 [0.]
5 I 5 [0.]
6 to 6 [0.]
7 a 7 [0.]
8 of 8 [0.]
9 and 9 [0.]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">filter_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Vocabulary(17 words)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;&lt;PAD&gt;&#39;, &#39;&lt;UNK&gt;&#39;, &#39;.&#39;, &#39;,&#39;, &#39;the&#39;, &#39;I&#39;, &#39;to&#39;, &#39;a&#39;, &#39;of&#39;, &#39;and&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">build_embedding_matrix</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.],
       [0.]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-encoding">Test encoding<a class="anchor-link" href="#Test-encoding">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="o">.</span><span class="n">from_glove_file</span><span class="p">(</span><span class="s1">&#39;/Users/hmamin/data/glove/glove.6B.50d.txt&#39;</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">)</span>
<span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Vocabulary(5002 words, 50-D embeddings)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;It&#39;s kind of a really nice day.&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0., 0., 0., 0., 0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoded</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">encoded</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
[22, 11, 923, 5, 9, 590, 3084, 124, 4]
0 0
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([  22,   11,  923,    5,    9,  590, 3084,  124,    4,    0])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#34;it &#39;s kind of a really nice day . &lt;PAD&gt;&#34;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;&lt;UNK&gt;&#39;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;&lt;PAD&gt;&#39;, &#39;&lt;UNK&gt;&#39;, &#39;the&#39;, &#39;,&#39;, &#39;.&#39;, &#39;of&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en_core_web_sm&#39;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">,</span> <span class="s1">&#39;tagger&#39;</span><span class="p">,</span> <span class="s1">&#39;ner&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Encoder</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">pad_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trim_start</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span> <span class="o">=</span> <span class="n">nlp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_end</span> <span class="o">=</span> <span class="n">pad_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="n">trim_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
        
        <span class="c1"># Trim sentence in case it&#39;s longer than max_len.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">:</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">]</span>

        <span class="c1"># Replace zeros at start or end, depending on choice of pad_end.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_end</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)]</span> <span class="o">=</span> <span class="n">encoded</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">):]</span> <span class="o">=</span> <span class="n">encoded</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">pad_end_bool</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">trim_start_bool</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">PAD END&#39;</span><span class="p">,</span> <span class="n">pad_end_bool</span><span class="p">,</span> <span class="s1">&#39;TRIM START&#39;</span><span class="p">,</span> <span class="n">trim_start_bool</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pad_end_bool</span><span class="p">,</span> <span class="n">trim_start_bool</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_long</span><span class="p">,</span> <span class="n">nlp</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pad_end_bool</span><span class="p">,</span> <span class="n">trim_start_bool</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
PAD END True TRIM START True
[2.200e+01 1.100e+01 9.230e+02 5.000e+00 9.000e+00 5.900e+02 3.084e+03
 1.240e+02 4.000e+00 1.000e+00]
[  16. 2239.    3.    7.   22.   16.    9. 1868.  366.    4.]

PAD END True TRIM START False
[2.200e+01 1.100e+01 9.230e+02 5.000e+00 9.000e+00 5.900e+02 3.084e+03
 1.240e+02 4.000e+00 1.000e+00]
[2.000e+00 1.571e+03 3.400e+01 4.131e+03 3.000e+00 2.000e+00 3.507e+03
 1.600e+01 2.239e+03 3.000e+00]

PAD END False TRIM START True
[1.000e+00 2.200e+01 1.100e+01 9.230e+02 5.000e+00 9.000e+00 5.900e+02
 3.084e+03 1.240e+02 4.000e+00]
[  16. 2239.    3.    7.   22.   16.    9. 1868.  366.    4.]

PAD END False TRIM START False
[1.000e+00 2.200e+01 1.100e+01 9.230e+02 5.000e+00 9.000e+00 5.900e+02
 3.084e+03 1.240e+02 4.000e+00]
[2.000e+00 1.571e+03 3.400e+01 4.131e+03 3.000e+00 2.000e+00 3.507e+03
 1.600e+01 2.239e+03 3.000e+00]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">nlp</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([  22.,   11.,  923.,    5.,    9.,  590., 3084.,  124.,    4.,
          0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">text_long</span> <span class="o">=</span> <span class="s2">&quot;The stars are bright, the sky is dark, and it is a cold night.&quot;</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_long</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([2.000e+00, 1.571e+03, 3.400e+01, 4.131e+03, 3.000e+00, 2.000e+00,
       3.507e+03, 1.600e+01, 2.239e+03, 3.000e+00])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">nlp</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">pad_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trim_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_long</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([2.000e+00, 1.571e+03, 3.400e+01, 4.131e+03, 3.000e+00, 2.000e+00,
       3.507e+03, 1.600e+01, 2.239e+03, 3.000e+00])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([   0.,   22.,   11.,  923.,    5.,    9.,  590., 3084.,  124.,
          4.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text_long</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;The&#39;,
 &#39;stars&#39;,
 &#39;are&#39;,
 &#39;bright&#39;,
 &#39;,&#39;,
 &#39;the&#39;,
 &#39;sky&#39;,
 &#39;is&#39;,
 &#39;dark&#39;,
 &#39;,&#39;,
 &#39;and&#39;,
 &#39;it&#39;,
 &#39;is&#39;,
 &#39;a&#39;,
 &#39;cold&#39;,
 &#39;night&#39;,
 &#39;.&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;,&#39;</pre>
</div>

</div>

</div>
</div>

</div>
</div>
 

